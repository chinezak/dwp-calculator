<!DOCTYPE html>
<html lang="en-GB">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DWP Clarity Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom styles for the slider thumb */
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            background: #005EA5; /* DWP Blue */
            cursor: pointer;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 0 2px rgba(0,0,0,0.5);
        }
        input[type=range]::-moz-range-thumb {
            width: 24px;
            height: 24px;
            background: #005EA5;
            cursor: pointer;
            border-radius: 50%;
            border: 2px solid white;
        }
        .chart-bar {
            transition: width 0.3s ease-in-out;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .gemini-feature h3 {
             font-size: 1.125rem; /* 18px */
             font-weight: 700;
             margin-bottom: 0.5rem; /* 8px */
             color: #111827;
        }
         .gemini-feature ul {
            list-style-type: disc;
            list-style-position: inside;
            padding-left: 1rem; /* 16px */
            margin-bottom: 1rem; /* 16px */
        }
        .gemini-feature li {
             margin-bottom: 0.25rem; /* 4px */
        }
        .gemini-feature .question {
            font-weight: bold;
            color: #1e40af; /* blue-800 */
        }
        .gemini-feature .tip {
            font-style: italic;
            color: #4b5563; /* gray-600 */
            padding-left: 1rem;
        }
        /* Modal styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 0.5rem;
            max-width: 500px;
            width: 90%;
            text-align: center;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <main class="w-full max-w-2xl bg-white rounded-xl shadow-lg p-6 md:p-10 space-y-8">
        <!-- Header Section -->
        <header class="text-center">
            <h1 class="text-3xl md:text-4xl font-extrabold text-gray-800">The DWP Clarity Calculator</h1>
            <p class="mt-2 text-lg text-gray-600">See how work pays. Instantly.</p>
        </header>

        <!-- API Key Input Section -->
        <div id="api-key-section" class="hidden bg-yellow-50 p-6 rounded-lg border border-yellow-300">
            <h3 class="text-lg font-bold text-yellow-800">Gemini API Key Required</h3>
            <p class="text-sm text-yellow-700 mt-1 mb-2">To use the AI features, please enter your free Google AI Studio API key. It will be saved securely in your browser.</p>
            <input type="password" id="api-key-input" placeholder="Enter your API key here" class="w-full p-2 border border-gray-300 rounded-md shadow-sm">
            <button id="save-api-key-btn" class="mt-2 w-full bg-yellow-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-yellow-600 transition-colors">Save Key</button>
            <p class="text-xs text-yellow-600 mt-2">You can get a key from <a href="https://aistudio.google.com/app/apikey" target="_blank" class="underline">Google AI Studio</a>.</p>
        </div>

        <!-- Input Configuration Section -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 bg-gray-50 p-6 rounded-lg border border-gray-200">
            <div>
                <label for="uc-payment" class="block text-sm font-medium text-gray-700 mb-1">Your monthly Universal Credit payment (£)</label>
                <input type="number" id="uc-payment" value="1000" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
            </div>
            <div>
                 <label class="block text-sm font-medium text-gray-700 mb-1">Do you have a Work Allowance? <span id="info-icon" class="text-blue-500 cursor-pointer">(?)</span></label>
                <select id="work-allowance" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    <option value="0">No, I don't have one</option>
                    <option value="404">Yes, £404 (no housing costs)</option>
                    <option value="673">Yes, £673 (with housing costs)</option>
                </select>
            </div>
             <div id="info-popup" class="hidden md:col-span-2 p-4 mt-2 text-sm text-blue-800 bg-blue-100 rounded-lg" role="alert">
                A Work Allowance is the amount you can earn before your Universal Credit payment is affected. You typically get it if you have children or limited capability for work.
            </div>
        </div>

        <!-- Interactive Calculator Section -->
        <div class="space-y-6">
            <!-- Total Income Display -->
            <div class="text-center bg-green-50 border-2 border-dashed border-green-300 rounded-lg p-6">
                <h2 class="text-lg font-semibold text-green-800">Your Total Estimated Take-Home Income per Month</h2>
                <p id="total-income" class="text-4xl md:text-5xl font-extrabold text-green-600 mt-2">£1,000.00</p>
            </div>

            <!-- Visual Bar Chart -->
            <div>
                <div id="income-chart" class="w-full h-12 bg-gray-200 rounded-full flex overflow-hidden">
                    <div id="earnings-bar" class="chart-bar bg-blue-500 flex items-center justify-center text-white font-semibold" style="width: 0%;"></div>
                    <div id="uc-bar" class="chart-bar bg-sky-300 flex items-center justify-center text-blue-900 font-semibold" style="width: 100%;"></div>
                </div>
                <div class="flex justify-between text-sm mt-2 px-1">
                    <div class="flex items-center">
                        <span class="w-3 h-3 bg-blue-500 rounded-full mr-2"></span>
                        <span id="earnings-legend">Your Earnings: £0</span>
                    </div>
                    <div class="flex items-center">
                        <span class="w-3 h-3 bg-sky-300 rounded-full mr-2"></span>
                        <span id="uc-legend">Universal Credit: £1000</span>
                    </div>
                </div>
            </div>

            <!-- Income Slider -->
            <div class="space-y-2">
                <label for="earnings-slider" class="block text-lg font-medium text-gray-800 text-center">
                    Monthly Earnings from Work: <span id="slider-value" class="font-bold text-blue-600">£0</span>
                </label>
                <input id="earnings-slider" type="range" min="0" max="3000" step="10" value="0" class="w-full h-3 bg-gray-200 rounded-lg appearance-none cursor-pointer">
            </div>
        </div>

        <!-- Gemini AI Features Section -->
        <div class="pt-8 border-t border-gray-200 space-y-6">
            <header class="text-center">
                <h2 class="text-2xl font-bold text-gray-800">Ready for the Next Step?</h2>
                <p class="mt-1 text-gray-600">Let our AI assistant help you explore your options.</p>
            </header>

            <!-- Feature 1: Job Ideas -->
            <div class="bg-gray-50 p-6 rounded-lg border border-gray-200">
                <label for="user-skills" class="block text-sm font-medium text-gray-700 mb-2">Enter your skills or past jobs (e.g., "customer service, cashier")</label>
                <input type="text" id="user-skills" placeholder="e.g. retail, driving, admin work" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                <button id="get-job-ideas" class="mt-4 w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors flex items-center justify-center gap-2">
                    ✨ Find Local Job Ideas
                </button>
                <div id="job-ideas-loader" class="hidden justify-center mt-4"><div class="loader"></div></div>
                <div id="job-ideas-result" class="mt-4 text-gray-700 gemini-feature"></div>
            </div>
            
            <!-- Job Specific Tools Section -->
            <div id="job-tools-section" class="hidden space-y-6">
                 <!-- Interview Prep -->
                <div class="bg-gray-50 p-6 rounded-lg border border-gray-200">
                    <label for="job-title-select" class="block text-sm font-medium text-gray-700 mb-2">Select a job to get personalised help:</label>
                    <select id="job-title-select" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 mb-4"></select>
                    <button id="get-interview-questions" class="w-full bg-purple-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-purple-700 transition-colors flex items-center justify-center gap-2">
                        ✨ Get Interview Questions
                    </button>
                    <div id="interview-questions-loader" class="hidden justify-center mt-4"><div class="loader"></div></div>
                    <div id="interview-questions-result" class="mt-4 text-gray-700 gemini-feature space-y-4"></div>
                </div>

                <!-- CV Helper -->
                <div class="bg-gray-50 p-6 rounded-lg border border-gray-200">
                     <h3 class="text-lg font-bold text-gray-800">CV / Resume Helper</h3>
                     <label for="cv-input" class="block text-sm font-medium text-gray-700 mb-2">Paste your CV or key work experience points here:</label>
                     <textarea id="cv-input" rows="6" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="e.g. Managed a team of 5 at a retail store..."></textarea>
                     <button id="get-cv-help" class="mt-4 w-full bg-teal-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-teal-700 transition-colors flex items-center justify-center gap-2">
                        ✨ Tailor My CV for This Job
                    </button>
                    <div id="cv-help-loader" class="hidden justify-center mt-4"><div class="loader"></div></div>
                    <div id="cv-help-result" class="mt-4 text-gray-700 gemini-feature space-y-4"></div>
                </div>
            </div>

            <!-- Action Plan -->
             <div id="action-plan-section" class="hidden bg-gray-50 p-6 rounded-lg border border-gray-200">
                <button id="get-action-plan" class="w-full bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 transition-colors flex items-center justify-center gap-2">
                    ✨ Generate a Positive Action Plan
                </button>
                 <div id="action-plan-loader" class="hidden justify-center mt-4"><div class="loader"></div></div>
                <div id="action-plan-result" class="mt-4 text-gray-700 gemini-feature"></div>
            </div>
        </div>

        <!-- Pitch Section -->
        <div class="pt-6 border-t border-gray-200">
             <h3 class="text-xl font-bold text-center text-gray-800 mb-4">Why is this a Game-Changer?</h3>
             <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                 <div class="bg-gray-50 p-4 rounded-lg">
                     <h4 class="font-bold text-blue-600">Radical Simplicity</h4>
                     <p class="text-sm text-gray-600 mt-1">Replaces complex forms with one intuitive slider, providing instant clarity.</p>
                 </div>
                 <div class="bg-gray-50 p-4 rounded-lg">
                     <h4 class="font-bold text-blue-600">Powerful Motivation</h4>
                     <p class="text-sm text-gray-600 mt-1">Visually proves that work always pays, tackling fear and building confidence.</p>
                 </div>
                 <div class="bg-gray-50 p-4 rounded-lg">
                     <h4 class="font-bold text-blue-600">Holistic Career Support</h4>
                     <p class="text-sm text-gray-600 mt-1">Offers AI-powered job ideas, interview prep, CV tailoring, and action plans.</p>
                 </div>
             </div>
        </div>
    </main>

    <!-- Error Modal -->
    <div id="error-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h2 class="text-xl font-bold text-red-600 mb-4">API Key Blocked (Error 403) - Project Setup Required</h2>
            <div id="modal-error-content" class="text-gray-700 space-y-4 text-left">
                <p>This is a <strong class="underline">Google Cloud configuration issue</strong>, not an app error. Even with the API enabled, it will be blocked until your project is fully set up.</p>
                <p class="font-bold text-center text-lg my-2">The most common reason is a missing Billing Account.</p>
                <div class="border-t border-b border-gray-200 py-4">
                    <p class="font-bold mb-2">Please do the following in Google Cloud:</p>
                    <ol class="list-decimal list-inside space-y-3">
                        <li>
                            <strong>Link a Billing Account to your project.</strong>
                            <p class="text-sm text-gray-600 ml-2">This is required by Google to use any API, even the free parts. You will not be charged unless you exceed the free tier.</p>
                        </li>
                        <li>
                            <strong>Confirm the "Generative Language API" is enabled.</strong>
                            <p class="text-sm text-gray-600 ml-2">You have done this, but it's good to double-check.</p>
                        </li>
                    </ol>
                </div>
                 <div class="grid grid-cols-1 gap-4 mt-4">
                    <a href="https://console.cloud.google.com/billing" target="_blank" class="inline-block w-full text-center bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition-colors text-lg">
                        Step 1: Go to Google Cloud Billing
                    </a>
                     <a href="https://console.cloud.google.com/apis/library/generativelanguage.googleapis.com" target="_blank" class="inline-block w-full text-center bg-gray-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-600 transition-colors">
                        Step 2: Check API Status
                    </a>
                </div>
                <p class="text-sm text-gray-500 text-center mt-4">After you have linked billing, please wait 5-10 minutes, then refresh the app and try again.</p>
            </div>
            <button id="close-modal-btn" class="mt-6 w-full bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors">I Understand</button>
        </div>
    </div>


    <script>
        // DOM Elements
        const ucPaymentInput = document.getElementById('uc-payment');
        const workAllowanceSelect = document.getElementById('work-allowance');
        const earningsSlider = document.getElementById('earnings-slider');
        const sliderValueDisplay = document.getElementById('slider-value');
        const totalIncomeDisplay = document.getElementById('total-income');
        const earningsBar = document.getElementById('earnings-bar');
        const ucBar = document.getElementById('uc-bar');
        const earningsLegend = document.getElementById('earnings-legend');
        const ucLegend = document.getElementById('uc-legend');
        const infoIcon = document.getElementById('info-icon');
        const infoPopup = document.getElementById('info-popup');

        // API Key Elements
        const apiKeySection = document.getElementById('api-key-section');
        const apiKeyInput = document.getElementById('api-key-input');
        const saveApiKeyBtn = document.getElementById('save-api-key-btn');
        
        // Modal Elements
        const errorModal = document.getElementById('error-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');

        // Gemini Feature DOM Elements
        const userSkillsInput = document.getElementById('user-skills');
        const getJobIdeasBtn = document.getElementById('get-job-ideas');
        const jobIdeasLoader = document.getElementById('job-ideas-loader');
        const jobIdeasResult = document.getElementById('job-ideas-result');
        
        const jobToolsSection = document.getElementById('job-tools-section');
        const jobTitleSelect = document.getElementById('job-title-select');
        
        const getInterviewQuestionsBtn = document.getElementById('get-interview-questions');
        const interviewQuestionsLoader = document.getElementById('interview-questions-loader');
        const interviewQuestionsResult = document.getElementById('interview-questions-result');

        const cvInput = document.getElementById('cv-input');
        const getCvHelpBtn = document.getElementById('get-cv-help');
        const cvHelpLoader = document.getElementById('cv-help-loader');
        const cvHelpResult = document.getElementById('cv-help-result');

        const actionPlanSection = document.getElementById('action-plan-section');
        const getActionPlanBtn = document.getElementById('get-action-plan');
        const actionPlanLoader = document.getElementById('action-plan-loader');
        const actionPlanResult = document.getElementById('action-plan-result');

        const TAPER_RATE = 0.55;
        const formatCurrency = (amount) => `£${amount.toFixed(2)}`;
        
        function getApiKey() {
            return localStorage.getItem('geminiApiKey');
        }

        function checkApiKey() {
            if (!getApiKey()) {
                apiKeySection.classList.remove('hidden');
                return false;
            }
            apiKeySection.classList.add('hidden');
            return true;
        }
        
        async function callGemini(payload, loaderElement, resultElement) {
            if (!checkApiKey()) {
                resultElement.innerHTML = `<p class="text-red-500 text-center">Please enter your API key above to use this feature.</p>`;
                window.scrollTo({ top: 0, behavior: 'smooth' });
                return null;
            }

            loaderElement.style.display = 'flex';
            resultElement.innerHTML = '';
            
            const apiKey = getApiKey();
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`;

            const MAX_RETRIES = 4; // Increased retries
            let attempt = 0;
            let lastError = null;

            while (attempt < MAX_RETRIES) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        lastError = { status: response.status };
                        if (response.status === 503 && attempt < MAX_RETRIES - 1) {
                            const delay = Math.pow(2, attempt) * 1000 + Math.random() * 1000;
                            console.log(`Service unavailable (503). Retrying in ${delay.toFixed(0)}ms...`);
                            await new Promise(resolve => setTimeout(resolve, delay));
                            attempt++;
                            continue;
                        }
                        throw new Error(`API request failed with status ${response.status}`);
                    }

                    const result = await response.json();
                    
                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        loaderElement.style.display = 'none';
                        return result.candidates[0].content.parts[0].text;
                    } else {
                        if (result.candidates && result.candidates.length > 0 && result.candidates[0].finishReason === 'SAFETY') {
                             throw new Error("Content blocked due to safety settings.");
                        }
                        throw new Error("No content received from API.");
                    }

                } catch (error) {
                    lastError = error;
                    // For network errors etc, break the loop immediately.
                    if (!error.message.includes("status")) {
                        break;
                    }
                }
            }
            
            // Handle final error state after retries
            loaderElement.style.display = 'none';
            console.error("Gemini API Error after all retries:", lastError);
            if (lastError?.message?.includes("403")) {
                errorModal.classList.remove('hidden');
            } else if (lastError?.message?.includes("404")) {
                resultElement.innerHTML = `<p class="text-red-500 text-center">API Error (404): The requested AI model was not found. The model name may be incorrect or unavailable in your region.</p>`;
            } else if (lastError?.message?.includes("SAFETY")) {
                resultElement.innerHTML = `<p class="text-red-500 text-center">Your request was blocked for safety reasons. Please modify your input and try again.</p>`;
            } else if (lastError?.status === 503) {
                 resultElement.innerHTML = `<p class="text-red-500 text-center">The AI service is still unavailable after several retries (Error 503). Please try again in a few minutes.</p>`;
            } else {
                resultElement.innerHTML = `<p class="text-red-500 text-center">An unknown error occurred. Please try again later.</p>`;
            }
            return null;
        }
        
        function updateCalculator() {
            const initialUcPayment = parseFloat(ucPaymentInput.value) || 0;
            const workAllowance = parseFloat(workAllowanceSelect.value) || 0;
            const earnings = parseFloat(earningsSlider.value) || 0;
            const earningsAboveAllowance = Math.max(0, earnings - workAllowance);
            const ucReduction = earningsAboveAllowance * TAPER_RATE;
            const adjustedUcPayment = Math.max(0, initialUcPayment - ucReduction);
            const totalTakeHomeIncome = earnings + adjustedUcPayment;
            sliderValueDisplay.textContent = `£${earnings}`;
            totalIncomeDisplay.textContent = formatCurrency(totalTakeHomeIncome);
            earningsLegend.textContent = `Your Earnings: £${earnings}`;
            ucLegend.textContent = `Universal Credit: £${adjustedUcPayment.toFixed(0)}`;
            if (totalTakeHomeIncome > 0) {
                const earningsPercentage = (earnings / totalTakeHomeIncome) * 100;
                const ucPercentage = (adjustedUcPayment / totalTakeHomeIncome) * 100;
                earningsBar.style.width = `${earningsPercentage}%`;
                ucBar.style.width = `${ucPercentage}%`;
            } else {
                earningsBar.style.width = '0%';
                ucBar.style.width = '100%';
            }
        }

        // --- Event Listeners ---
        ucPaymentInput.addEventListener('input', updateCalculator);
        workAllowanceSelect.addEventListener('change', updateCalculator);
        earningsSlider.addEventListener('input', updateCalculator);
        
        infoIcon.addEventListener('click', () => {
            infoPopup.classList.toggle('hidden');
        });

        saveApiKeyBtn.addEventListener('click', () => {
            const key = apiKeyInput.value.trim();
            if (key) {
                localStorage.setItem('geminiApiKey', key);
                apiKeyInput.value = '';
                checkApiKey();
            }
        });

        closeModalBtn.addEventListener('click', () => {
            errorModal.classList.add('hidden');
        });

        getJobIdeasBtn.addEventListener('click', async () => {
            const skills = userSkillsInput.value.trim();
            if (!skills) {
                jobIdeasResult.innerHTML = '<p class="text-red-500 text-center">Please enter your skills or past jobs first.</p>';
                return;
            }
            const targetEarnings = earningsSlider.value;
            const prompt = `Based on the skills "${skills}" and a target monthly earning of £${targetEarnings}, suggest 3 specific job roles available in the UK. For each role, provide a brief description and list typical skills required. Use British English spelling.`;
            
            const payload = {
                contents: [{ role: "user", parts: [{ text: prompt }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            jobs: {
                                type: "ARRAY",
                                items: {
                                    type: "OBJECT",
                                    properties: {
                                        job_title: { type: "STRING" },
                                        description: { type: "STRING" },
                                        skills: { type: "ARRAY", items: { type: "STRING" } }
                                    },
                                    required: ["job_title", "description", "skills"]
                                }
                            }
                        }
                    }
                }
            };
            
            const jsonString = await callGemini(payload, jobIdeasLoader, jobIdeasResult);

            if (jsonString) {
                try {
                    const data = JSON.parse(jsonString);
                    let html = '';
                    jobTitleSelect.innerHTML = ''; // Clear previous options
                    data.jobs.forEach(job => {
                        html += `<h3>${job.job_title}</h3><p>${job.description}</p><ul>${job.skills.map(s => `<li>${s}</li>`).join('')}</ul>`;
                        const option = document.createElement('option');
                        option.value = job.job_title;
                        option.textContent = job.job_title;
                        jobTitleSelect.appendChild(option);
                    });
                    jobIdeasResult.innerHTML = html;
                    
                    jobToolsSection.classList.remove('hidden');
                    actionPlanSection.classList.remove('hidden');
                } catch(e) {
                    console.error("Error parsing JSON response:", e);
                    jobIdeasResult.innerHTML = `<p class="text-red-500 text-center">There was an issue processing the job ideas. The response was: ${jsonString}</p>`;
                }
            }
        });

        getInterviewQuestionsBtn.addEventListener('click', async () => {
            const selectedJob = jobTitleSelect.value;
            if (!selectedJob) return;

            const prompt = `Generate 5 common interview questions for a "${selectedJob}" role. For each question, provide a brief, helpful tip on how to answer it well. Use British English spelling.`;
            
            const payload = {
                contents: [{ role: "user", parts: [{ text: prompt }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            interview_questions: {
                                type: "ARRAY",
                                items: {
                                    type: "OBJECT",
                                    properties: {
                                        question: { type: "STRING" },
                                        tip: { type: "STRING" }
                                    },
                                    required: ["question", "tip"]
                                }
                            }
                        }
                    }
                }
            };

            const jsonString = await callGemini(payload, interviewQuestionsLoader, interviewQuestionsResult);

            if (jsonString) {
                try {
                    const data = JSON.parse(jsonString);
                    let html = '';
                    if (data.interview_questions && data.interview_questions.length > 0) {
                        html = data.interview_questions.map(item => `
                            <div class="p-4 bg-white border border-gray-200 rounded-lg shadow-sm">
                                <p class="question">${item.question}</p>
                                <p class="tip mt-2"><strong>Tip:</strong> ${item.tip}</p>
                            </div>
                        `).join('');
                    } else {
                        html = '<p class="text-center text-gray-500">No questions were generated.</p>';
                    }
                    interviewQuestionsResult.innerHTML = html;
                } catch (e) {
                    console.error("Error parsing interview questions JSON:", e);
                    interviewQuestionsResult.innerHTML = `<p class="text-red-500 text-center">There was an issue processing the interview questions. The raw response was: ${jsonString}</p>`;
                }
            }
        });

        getCvHelpBtn.addEventListener('click', async () => {
            const selectedJob = jobTitleSelect.value;
            const cvText = cvInput.value.trim();

            if(!selectedJob) {
                cvHelpResult.innerHTML = `<p class="text-red-500 text-center">Please select a job first.</p>`;
                return;
            }
            if(!cvText) {
                cvHelpResult.innerHTML = `<p class="text-red-500 text-center">Please paste your CV or work experience first.</p>`;
                return;
            }

            const prompt = `Act as a helpful UK-based career coach. A user is applying for a "${selectedJob}" role. Their current CV/experience is:\n\n"${cvText}"\n\nPlease provide constructive feedback on how to tailor this CV for the role. Use British English spelling and grammar. Suggest specific improvements. Ensure every bullet point and sentence you generate starts with a capital letter. Structure your response as a JSON object.`;
            
            const payload = {
                contents: [{ role: "user", parts: [{ text: prompt }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            overallFeedback: { type: "STRING" },
                            suggestedSummary: { 
                                type: "ARRAY", 
                                items: { type: "STRING" },
                                description: "A short, impactful personal summary, broken into a few sentences. Each sentence must start with a capital letter."
                             },
                            keywords: { type: "ARRAY", items: { type: "STRING" } },
                            revisedExperience: {
                                type: "ARRAY",
                                items: {
                                    type: "OBJECT",
                                    properties: {
                                        title: { type: "STRING" },
                                        points: { 
                                            type: "ARRAY", 
                                            items: { type: "STRING" },
                                            description: "An array of bullet points. Each bullet point must be a full sentence starting with a capital letter."
                                        }
                                    },
                                    required: ["title", "points"]
                                }
                            }
                        }
                    }
                }
            };

            const jsonString = await callGemini(payload, cvHelpLoader, cvHelpResult);
            
            if(jsonString) {
                try {
                    let sanitizedString = jsonString.trim();
                    if (sanitizedString.startsWith('```json')) {
                        sanitizedString = sanitizedString.substring(7).trim();
                        if (sanitizedString.endsWith('```')) {
                            sanitizedString = sanitizedString.slice(0, -3).trim();
                        }
                    }

                    const data = JSON.parse(sanitizedString);
                    let html = `
                        <div class="p-4 bg-white border border-gray-200 rounded-lg shadow-sm text-left">
                            <h3 class="font-bold text-lg mb-2 text-gray-800">Overall Feedback</h3>
                            <p class="text-gray-600">${data.overallFeedback || 'No overall feedback provided.'}</p>
                        </div>
                        <div class="p-4 bg-white border border-gray-200 rounded-lg shadow-sm text-left">
                            <h3 class="font-bold text-lg mb-2 text-gray-800">Suggested Personal Summary</h3>
                            <div class="space-y-2">
                                ${(data.suggestedSummary || ['No summary suggested.']).map(s => `<p class="text-gray-600">${s}</p>`).join('')}
                            </div>
                        </div>
                        <div class="p-4 bg-white border border-gray-200 rounded-lg shadow-sm text-left">
                            <h3 class="font-bold text-lg mb-2 text-gray-800">Keywords to Include</h3>
                            <ul class="list-disc list-inside text-gray-600">${(data.keywords || []).map(k => `<li>${k}</li>`).join('')}</ul>
                        </div>
                        <div class="p-4 bg-white border border-gray-200 rounded-lg shadow-sm text-left">
                            <h3 class="font-bold text-lg mb-2 text-gray-800">Revised Experience Points</h3>
                            ${(data.revisedExperience || []).map(exp => `
                                <div class="mt-4">
                                    <h4 class="font-semibold text-gray-700">${exp.title}</h4>
                                    <ul class="list-disc list-inside text-gray-600 ml-4">${(exp.points || []).map(p => `<li>${p}</li>`).join('')}</ul>
                                </div>
                            `).join('')}
                        </div>
                    `;
                    cvHelpResult.innerHTML = html;
                } catch(e) {
                     console.error("Error parsing CV help JSON:", e);
                    cvHelpResult.innerHTML = `<p class="text-red-500 text-center">There was an issue processing the CV feedback. The AI returned a response that was not structured correctly. Please try again.</p>`;
                }
            }
        });

        getActionPlanBtn.addEventListener('click', async () => {
             const targetEarnings = earningsSlider.value;
             const jobIdeas = jobIdeasResult.innerText;
             const prompt = `A person wants to earn £${targetEarnings} per month and is considering these job roles:\n${jobIdeas}\nCreate a simple, encouraging 3-step action plan to help them get started. Use a positive and empowering tone and British English spelling. Format each step starting with **Step X:**.`;
             const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };

             const textResponse = await callGemini(payload, actionPlanLoader, actionPlanResult);

             if(textResponse) {
                let html = textResponse.replace(/\*\*(.*?)\*\*/g, '<h3>$1</h3>').replace(/\n/g, '<br/>');
                actionPlanResult.innerHTML = html;
             }
        });

        // Initial setup on page load
        window.addEventListener('load', () => {
            updateCalculator();
            checkApiKey();
        });
    </script>
</body>
</html>

